
NASM = "nasm -f macho"
LD   = "ld -arch i386 -macosx_version_min 10.7.0 -no_pie"
BUILD_DIR = "build"

def nasm_file (target, src)
    file target => src do
        sh "#{NASM} -o #{target} #{src}"
    end
end
def link_file (target, libs)
    file target => libs do
        sh "#{LD} -o #{target} #{libs}"
    end
end
def interactive_task (name, target, watch_list)
    task name => target do
        sh "when-changed -rs #{watch_list} -c 'clear; rake #{target}'"
    end
end

def DEFAULT_RUN_ACTION (file)
    sh file
end

$nasm_path_map = Hash.new
$nasm_src_map = Hash.new

def nasm_target (target, src, run_action = method(:DEFAULT_RUN_ACTION))
    target_path = "#{BUILD_DIR}/#{target}"
    obj_path    = "#{target_path}.o"

    $nasm_path_map[target] = target_path
    $nasm_src_map[target]  = src

    nasm_file(obj_path, src)
    link_file(target_path, obj_path)

    task target => target_path do
        run_action.call(target_path)
    end
    interactive_task("i#{target}", target, src)
end
def debug_task (name, target, script)
    target_path = $nasm_path_map[target]
    # target_path = "#{BUILD_DIR}/#{target}"
    task name => target_path do
        sh "lldb #{target_path} -s #{script}"
    end
    interactive_task("i#{name}", name, $nasm_src_map[target])
end

nasm_target("a3", "src/assignment_3_osx.asm")
nasm_target("a3_min", "src/assignment_3_min_osx.asm")

debug_task("debug", "a3_min", "src/lldb_setup_a3_min.txt")
debug_task("auto_debug", "a3_min", "src/lldb_automated_a3_min.txt")

task :default => "a3"
task :clean do
    sh "rm build/*"
end



